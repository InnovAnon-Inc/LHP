<html>
<head>

<script src="lib/kick.js"></script>
<script src="lib/note.js"></script>
<script src="lib/piano.js"></script>
<script src="lib/piano2.js"></script>
<script src="lib/rhythm.js"></script>

<script src="music7.js"></script>
<script>
	/*
	var context = new AudioContext();
	var now = context.currentTime;
	now++;
	
	var measureLength = 6 * 40 / 60;
	var pulses  = [1, 2, 3, 4, 6, 8];
	var pulsesP = [8, 6, 4, 3, 2, 1];
	var s = new Song (context, measureLength, pulses, pulsesP);
	s.play (now, Math.floor (Math.random () * Number.MAX_SAFE_INTEGER));
	*/

try {	
	var context = new AudioContext();
	var now = context.currentTime;
	now++;

	var bf       = 432;
	var scale    = [
		1/1, 16/15, 9/8, 6/5, 5/4, 4/3, 7/5, 3/2,	8/5, 5/3, 16/9, 15/8];
	var octaves  = 2;
	var octave   = 0;
	var gain     = .1;
	var richness = 5;
	var piano1   = new Piano2 (
		context, bf, scale, octaves, octave + 0, gain, richness);
	var piano2   = new Piano2 (
		context, bf, scale, octaves, octave + 1, gain, richness);
	var piano3   = new Piano2 (
		context, bf, scale, octaves, octave - 1, gain, richness);
		
	//var modes = [0, 2, 4, 5, 7, 9, 11];
	//var key, mode, note;
	//[(note + key + mode) % scale.length]
	
	var rhythm1 = new Rhythm (13, 7, 0);
	var rhythm2 = new Rhythm (17, 7, 1);
	var rhythm3 = new Rhythm (11, 7, 2);
	
	var directions = [-1, -1, 1, 1, -1, 1];
	var magnitudes = [1, 1, 0];
	
	function Melody (scale, directions, magnitudes) {
		this.scale      = scale;
		this.directions = directions;
		this.magnitudes = magnitudes;
		this.d = 0;
		this.m = 0;
	}
	Melody.prototype.next = function (chord) {
		var prev = this.prev;
		var direction = this.directions[this.d];
		var magnitude = this.magnitudes[this.m];
		
		if (chord is undefined) {
			nextNote (prev, direction, magnitude);
			// prev + direction * magnitude;
		} else {
			if (prev is undefined) {
				
			} else {
				// find a note in chord in direction with at least magnitude
			}
		}
		
		this.d = (this.d + 1) % this.directions.length;
		this.m = (this.m + 1) % this.magnitudes.length;
	}

	var t = 1, r, b = 0;
	function cycle () {
		var chordI  = [0,  4,  7];
		var chordIV = [5,  9, 12];
		var chordV  = [7, 11, 14];
		
		for (r = 1; r <= 3; r++, b++) {
			if (rhythm1.beat ())
				piano1.trigger (now, chordI, t);
			if (rhythm2.beat ())
				piano2.trigger (now, chordI, t);
			if (rhythm3.beat ())
				piano3.trigger (now, chordI, t);
			now += t;
		}
		for (r = 1; r <= 3; r++, b++) {
			if (rhythm1.beat ())
				piano1.trigger (now, chordIV, t);
			if (rhythm2.beat ())
				piano2.trigger (now, chordIV, t);
			if (rhythm3.beat ())
				piano3.trigger (now, chordIV, t);
			now += t;
		}
		for (r = 1; r <= 3; r++, b++) {
			if (rhythm1.beat ())
				piano1.trigger (now, chordV, t);
			if (rhythm2.beat ())
				piano2.trigger (now, chordV, t);
			if (rhythm3.beat ())
				piano3.trigger (now, chordV, t);
			now += t;
		}
		for (r = 1; r <= 3; r++, b++) {
			if (rhythm1.beat ())
				piano1.trigger (now, chordIV, t);
			if (rhythm2.beat ())
				piano2.trigger (now, chordIV, t);
			if (rhythm3.beat ())
				piano3.trigger (now, chordIV, t);
			now += t;
		}
		
		setTimeout(cycle, Math.max (0, Math.floor (now - context.currentTime) * 1000 - 100));
	}
	cycle ();
} catch (e) { alert (e) }
</script>

</head>
</html>
