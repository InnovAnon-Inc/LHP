<html>
<head>

<script src="lib/kick.js"></script>
<script src="lib/note.js"></script>
<script src="lib/piano.js"></script>
<script src="lib/piano2.js"></script>
<script src="lib/rhythm.js"></script>

<script src="music7.js"></script>
<script>
	/*
	var context = new AudioContext();
	var now = context.currentTime;
	now++;
	
	var measureLength = 6 * 40 / 60;
	var pulses  = [1, 2, 3, 4, 6, 8];
	var pulsesP = [8, 6, 4, 3, 2, 1];
	var s = new Song (context, measureLength, pulses, pulsesP);
	s.play (now, Math.floor (Math.random () * Number.MAX_SAFE_INTEGER));
	*/

try {	
	var context = new AudioContext();
	var now = context.currentTime;
	now++;

	var bf       = 432;
	var scale    = [
		1/1, 16/15, 9/8, 6/5, 5/4, 4/3, 7/5, 3/2,	8/5, 5/3, 16/9, 15/8];
	var octaves  = 2;
	var octave   = 0;
	var gain     = .1;
	var richness = 5;
	var piano0   = new Piano2 (
		context, bf, scale, octaves, octave + 0, gain, richness);
	var piano1   = new Piano2 (
		context, bf, scale, octaves, octave + 0, gain, richness);
	var piano2   = new Piano2 (
		context, bf, scale, octaves, octave + 1, gain, richness);
	var piano3   = new Piano2 (
		context, bf, scale, octaves, octave - 1, gain, richness);
		
	//var modes = [0, 2, 4, 5, 7, 9, 11];
	//var key, mode, note;
	//[(note + key + mode) % scale.length]
	
	var rhythm0 = new Rhythm (12, 7, 5);
	var rhythm1 = new Rhythm (13, 7, 0);
	var rhythm2 = new Rhythm (17, 7, 1);
	var rhythm3 = new Rhythm (11, 7, 2);
	
	function includes (chord, note, scale) {
		var i;
		var m = note % scale.length;
		for (i = 0; i < chord.length; i++)
			if (chord[i] % scale.length == m)
				return true;
		return false;
	}
	
	function Melody (scale, start, directions, magnitudes) {
		this.scale      = scale;
		this.directions = directions;
		this.magnitudes = magnitudes;
		this.d = 0;
		this.m = 0;
		this.start = start;
	}
	Melody.prototype.next = function (chord, modulate) {
		var scale = this.scale;
		
		var direction = this.directions[this.d];
		var magnitude = this.magnitudes[this.m];
		
		var prev = this.prev;
		var next;
		
		if (prev === undefined)
			next = chord[this.start % chord.length];
		else {
			next = (prev + direction * magnitude) % scale.length;
			if (next < 0) next += scale.length;
			//if (chord !== undefined) {
			if (modulate) {
				while (! includes (chord, next, scale)) {
					next = (next + direction) % scale.length;
					if (next < 0) next += scale.length;
				}
			}
		}
		
		this.d = (this.d + 1) % this.directions.length;
		this.m = (this.m + 1) % this.magnitudes.length;
		
		this.prev = next;
		return next;
	};
	
	function getScale (scale, modes, mode) {
		var ret = new Array (scale.length);
		var i, sum;
		for (i = sum = 0; i < ret.length; i++) {
			ret[i] = sum % scale.length;
			sum += modes[(i + mode) % modes.length];
		}
		return ret;
	}
	
	var modes = [2, 2, 1, 2, 2, 2, 1];
	var subscale = getScale (scale, modes, 0);
	
	var directions = [-1, -1, 1, 1, -1, 1];
	var magnitudes = [ 1,  0, 1, 1,  0];
	
	var melody1 = new Melody (subscale, 0, directions, magnitudes);
	directions = directions.slice ().rotate (1);
	magnitudes = magnitudes.slice ().rotate (1);
	var melody2 = new Melody (subscale, 1, directions, magnitudes);
	directions = directions.slice ().rotate (1);
	magnitudes = magnitudes.slice ().rotate (1);
	var melody3 = new Melody (subscale, 2, directions, magnitudes);
	
	function getChord (chord) {
		var ret = new Array (chord.length);
		var i;
		for (i = 0; i < chord.length; i++)
			ret[i] = subscale[chord[i] % subscale.length];
		return ret;
	}
	
	var play0 = true;
	var play1 = true;
	var play2 = false;
	var play3 = false;
	
	var t = 1, r, b = 0, m = 0;
	function cycle () {
		// TODO get chords from subscale
		var chordI  = [0 + 0, 2 + 0, 4 + 0];
		var chordIV = [0 + 3, 2 + 3, 4 + 3];
		var chordV  = [0 + 4, 2 + 4, 4 + 4];
		var note;
		
		for (r = 1; r <= 3; r++, b++) {
			if (play0 && m % 1 == 0 && rhythm0.beat ())
			//if (r == 1)
				piano0.trigger (now, getChord (chordI), t);
			if (play1 && m % 2 == 0 && rhythm1.beat ()) {
				note = melody1.next (chordI, r == 1);
				piano1.trigger (now, [note], t);
			}
			if (play2 && m % 3 == 0 && rhythm2.beat ()) {
				note = melody2.next (chordI, r == 1);
				piano2.trigger (now, [note], t);
			}
			if (play3 && m % 5 == 0 && rhythm3.beat ()) {
				note = melody3.next (chordI, r == 1);
				piano3.trigger (now, [note], t);
			}
			now += t;
		}
		for (r = 1; r <= 3; r++, b++) {
			if (play0 && m % 1 == 0 && rhythm0.beat ())
			//if (r == 1)
				piano0.trigger (now, getChord (chordIV), t);
			if (play1 && m % 2 == 0 && rhythm1.beat ()) {
				note = melody1.next (chordIV, r == 1);
				piano1.trigger (now, [note], t);
			}
			if (play2 && m % 3 == 0 && rhythm2.beat ()) {
				note = melody2.next (chordIV, r == 1);
				piano2.trigger (now, [note], t);
			}
			if (play3 && m % 5 == 0 && rhythm3.beat ()) {
				note = melody3.next (chordIV, r == 1);
				piano3.trigger (now, [note], t);
			}
			now += t;
		}
		for (r = 1; r <= 3; r++, b++) {
			if (play0 && m % 1 == 0 && rhythm0.beat ())
			//if (r == 1)
				piano0.trigger (now, getChord (chordV), t);
			if (play1 && m % 2 == 0 && rhythm1.beat ()) {
				note = melody1.next (chordV, r == 1);
				piano1.trigger (now, [note], t);
			}
			if (play2 && m % 3 == 0 && rhythm2.beat ()) {
				note = melody2.next (chordV, r == 1);
				piano2.trigger (now, [note], t);
			}
			if (play3 && m % 5 == 0 && rhythm3.beat ()) {
				note = melody3.next (chordV, r == 1);
				piano3.trigger (now, [note], t);
			}
			now += t;
		}
		for (r = 1; r <= 3; r++, b++) {
			if (play0 && m % 1 == 0 && rhythm0.beat ())
			//if (r == 1)
				piano0.trigger (now, getChord (chordIV), t);
			if (play1 && m % 2 == 0 && rhythm1.beat ()) {
				note = melody1.next (chordIV, r == 1);
				piano1.trigger (now, [note], t);
			}
			if (play2 && m % 3 == 0 && rhythm2.beat ()) {
				note = melody2.next (chordIV, r == 1);
				piano2.trigger (now, [note], t);
			}
			if (play3 && m % 5 == 0 && rhythm3.beat ()) {
				note = melody3.next (chordIV, r == 1);
				piano3.trigger (now, [note], t);
			}
			now += t;
		}
		m++;
		
		setTimeout(cycle, Math.max (0, Math.floor (now - context.currentTime) * 1000 - 100));
	}
	cycle ();
} catch (e) { alert (e) }
</script>

</head>
</html>
